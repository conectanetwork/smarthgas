<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartHGas Dashboard - CORREGIDO</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* CSS simplificado para debug */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; background: white; padding: 20px; border-radius: 10px; }
        .chart-container { background: white; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .chart-canvas { width: 100%; height: 400px; }
        .debug { background: #fffacd; padding: 15px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SmartHGas Dashboard - VERSI√ìN CORREGIDA</h1>
            <p>Gr√°fico de Consumo con Ventana Deslizante</p>
        </div>

        <div class="debug">
            <h3>üîß Estado del Sistema:</h3>
            <p id="status">Inicializando...</p>
        </div>

        <div class="chart-container">
            <h3>üìà Consumo √öltimas 24 Horas</h3>
            <canvas class="chart-canvas" id="consumptionChart"></canvas>
        </div>
    </div>

    <script>
        console.log('üöÄ === DASHBOARD CORREGIDO INICIANDO ===');
        
        const SUPABASE_URL = 'https://uooftjtllmsnugdcldvc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvb2Z0anRsbG1zbnVnZGNsZHZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NzU3MTgsImV4cCI6MjA4MzA1MTcxOH0.L5NiZfGOlDT1vie9xEkFAFGwD-mLKAfk29FT02RwEOo';
        
        let supabaseClient = null;
        let consumptionChart = null;
        
        // Inicializar Supabase
        try {
            const { createClient } = supabase;
            supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('‚úÖ Cliente Supabase inicializado');
            updateStatus('‚úÖ Supabase conectado');
        } catch (error) {
            console.error('‚ùå Error inicializando Supabase:', error);
            updateStatus('‚ùå Error en Supabase: ' + error.message);
        }

        function updateStatus(message) {
            const statusElement = document.getElementById('status');
            if (statusElement) {
                statusElement.textContent = message;
            }
        }

        function calculateNetWeightAndPercentage(totalWeight, emptyWeight, fullWeight) {
            const netWeight = Math.max(0, totalWeight - emptyWeight);
            const maxNetWeight = fullWeight - emptyWeight;
            const percentage = maxNetWeight > 0 ? Math.min(100, (netWeight / maxNetWeight) * 100) : 0;
            return { netWeight, percentage };
        }
        
        function initConsumptionChart() {
            console.log('üìä Inicializando gr√°fico...');
            const canvas = document.getElementById('consumptionChart');
            if (!canvas) {
                console.error('‚ùå Canvas no encontrado');
                updateStatus('‚ùå Error: Canvas no encontrado');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            consumptionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Peso Neto (kg)',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            title: { display: true, text: 'Peso Neto (kg)' }
                        },
                        x: { 
                            title: { display: true, text: 'Hora' }
                        }
                    }
                }
            });
            
            console.log('‚úÖ Gr√°fico inicializado');
            updateStatus('‚úÖ Gr√°fico inicializado');
        }
        
        // ============================================
        // FUNCI√ìN CORREGIDA - SIN ERRORES DE FORMATO
        // ============================================
        
        async function updateChartFromSupabase() {
            console.log('üîç === ACTUALIZANDO GR√ÅFICO (VERSI√ìN CORREGIDA) ===');
            
            if (!supabaseClient || !consumptionChart) {
                console.error('‚ùå Cliente o gr√°fico no disponible');
                updateStatus('‚ùå Error: Cliente o gr√°fico no disponible');
                return;
            }
            
            try {
                updateStatus('üîÑ Obteniendo datos...');
                
                const now = new Date();
                const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                
                console.log('üìÖ Consultando datos desde:', yesterday.toISOString());
                
                const { data, error } = await supabaseClient
                    .from('sensor_data')
                    .select('weight, timestamp')
                    .eq('device_id', 'ESP32_SMARTGAS_DEMO')
                    .gte('timestamp', yesterday.toISOString())
                    .order('timestamp', { ascending: true });

                if (error) {
                    console.error('‚ùå Error en consulta:', error);
                    updateStatus('‚ùå Error consultando datos: ' + error.message);
                    return;
                }
                
                console.log(`‚úÖ Datos obtenidos: ${data ? data.length : 0} registros`);
                updateStatus(`‚úÖ Datos obtenidos: ${data ? data.length : 0} registros`);
                
                // Configuraci√≥n de pesos
                const emptyWeight = 5.0;  // Valor fijo para debug
                const fullWeight = 13.0;  // Valor fijo para debug
                
                // ============================================
                // CORRECCI√ìN CR√çTICA: FORMATO DE HORA SIMPLE
                // ============================================
                
                const labels = [];
                const netWeights = [];
                
                // Generar 24 horas - M√âTODO SIMPLE Y SEGURO
                for (let i = 23; i >= 0; i--) {
                    const slotTime = new Date(now.getTime() - (i * 60 * 60 * 1000));
                    
                    // M√âTODO CORREGIDO: Usar getHours() directamente
                    const hour = slotTime.getHours().toString().padStart(2, '0');
                    labels.push(hour + ':00');  // Formato simple: "14:00", "15:00", etc.
                }
                
                console.log('üïê Labels generados (CORREGIDO):', labels);
                
                // Procesar datos
                if (!data || data.length === 0) {
                    console.log('‚ö†Ô∏è Sin datos, usando valores por defecto');
                    for (let i = 0; i < 24; i++) {
                        netWeights.push(0);
                    }
                    updateStatus('‚ö†Ô∏è Sin datos disponibles - Mostrando gr√°fico vac√≠o');
                } else {
                    // Obtener √∫ltimo peso
                    const lastData = data[data.length - 1];
                    const lastTotalWeight = parseFloat(lastData.weight) || 0;
                    const { netWeight: lastNetWeight } = calculateNetWeightAndPercentage(lastTotalWeight, emptyWeight, fullWeight);
                    
                    console.log('üìè √öltimo peso neto:', lastNetWeight.toFixed(2) + 'kg');
                    
                    // Llenar slots con datos reales o √∫ltimo disponible
                    for (let i = 23; i >= 0; i--) {
                        const slotTime = new Date(now.getTime() - (i * 60 * 60 * 1000));
                        const slotStart = new Date(slotTime.getTime() - 30 * 60 * 1000);
                        const slotEnd = new Date(slotTime.getTime() + 30 * 60 * 1000);
                        
                        let slotData = null;
                        for (const item of data) {
                            const itemTime = new Date(item.timestamp);
                            if (itemTime >= slotStart && itemTime <= slotEnd) {
                                slotData = item;
                                break;
                            }
                        }
                        
                        if (slotData) {
                            const totalWeight = parseFloat(slotData.weight) || 0;
                            const { netWeight } = calculateNetWeightAndPercentage(totalWeight, emptyWeight, fullWeight);
                            netWeights.push(netWeight);
                            console.log(`‚úÖ ${labels[23-i]}: ${netWeight.toFixed(2)}kg (dato real)`);
                        } else {
                            netWeights.push(lastNetWeight);
                            console.log(`üîÑ ${labels[23-i]}: ${lastNetWeight.toFixed(2)}kg (√∫ltimo disponible)`);
                        }
                    }
                    
                    updateStatus(`‚úÖ Gr√°fico actualizado con ${data.length} registros`);
                }
                
                // Actualizar gr√°fico
                consumptionChart.data.labels = labels;
                consumptionChart.data.datasets[0].data = netWeights;
                consumptionChart.update();
                
                console.log('‚úÖ Gr√°fico actualizado exitosamente');
                console.log('üìä Datos finales:', netWeights);
                
            } catch (error) {
                console.error('‚ùå Error cr√≠tico:', error);
                updateStatus('‚ùå Error cr√≠tico: ' + error.message);
            }
        }
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inicializando dashboard corregido...');
            
            initConsumptionChart();
            
            // Primera actualizaci√≥n despu√©s de 3 segundos
            setTimeout(() => {
                console.log('üîÑ Primera actualizaci√≥n...');
                updateChartFromSupabase();
            }, 3000);
            
            // Actualizaci√≥n cada 2 minutos para debug
            setInterval(() => {
                console.log('üîÑ Actualizaci√≥n autom√°tica...');
                updateChartFromSupabase();
            }, 2 * 60 * 1000);
            
            console.log('‚úÖ Dashboard inicializado');
        });
        
        // Funci√≥n manual para debug
        window.updateChart = updateChartFromSupabase;
        
        console.log('üåê Dashboard corregido listo');
        console.log('üí° Usa updateChart() en consola para actualizar manualmente');
    </script>
</body>
</html>
