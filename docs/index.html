<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartHGas Dashboard - TOTALMENTE CORREGIDO</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; background: white; padding: 20px; border-radius: 10px; }
        .status-bar { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .chart-container { background: white; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .chart-canvas { width: 100%; height: 400px; }
        .debug-info { background: #fff3cd; padding: 10px; margin: 5px 0; border-radius: 5px; font-size: 14px; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SmartHGas Dashboard - TOTALMENTE CORREGIDO</h1>
            <p>Versi√≥n con manejo seguro de errores</p>
        </div>

        <div class="status-bar">
            <div class="debug-info" id="main-status">üîÑ Inicializando sistema...</div>
        </div>

        <div class="chart-container">
            <h3>üìà Consumo √öltimas 24 Horas</h3>
            <canvas class="chart-canvas" id="consumptionChart"></canvas>
        </div>
    </div>

    <script>
        console.log('üöÄ === DASHBOARD TOTALMENTE CORREGIDO ===');
        
        const SUPABASE_URL = 'https://uooftjtllmsnugdcldvc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvb2Z0anRsbG1zbnVnZGNsZHZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NzU3MTgsImV4cCI6MjA4MzA1MTcxOH0.L5NiZfGOlDT1vie9xEkFAFGwD-mLKAfk29FT02RwEOo';
        
        let supabaseClient = null;
        let consumptionChart = null;
        
        // Funci√≥n segura para actualizar estado
        function updateStatus(message, isError = false) {
            const statusElement = document.getElementById('main-status');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = isError ? 'debug-info error' : 'debug-info success';
            }
            console.log(message);
        }

        // Inicializar Supabase con manejo de errores
        try {
            const { createClient } = supabase;
            supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            updateStatus('‚úÖ Supabase conectado correctamente');
        } catch (error) {
            updateStatus('‚ùå Error inicializando Supabase: ' + error.message, true);
        }

        // Funci√≥n segura para calcular peso neto
        function calculateNetWeightAndPercentage(totalWeight, emptyWeight, fullWeight) {
            const netWeight = Math.max(0, totalWeight - emptyWeight);
            const maxNetWeight = fullWeight - emptyWeight;
            const percentage = maxNetWeight > 0 ? Math.min(100, (netWeight / maxNetWeight) * 100) : 0;
            return { netWeight, percentage };
        }
        
        // Inicializar gr√°fico con manejo de errores
        function initConsumptionChart() {
            try {
                const canvas = document.getElementById('consumptionChart');
                if (!canvas) {
                    throw new Error('Canvas no encontrado en el DOM');
                }
                
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    throw new Error('Contexto 2D no disponible');
                }
                
                consumptionChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array(24).fill(''),
                        datasets: [{
                            label: 'Peso Neto (kg)',
                            data: Array(24).fill(0),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                title: { display: true, text: 'Peso Neto (kg)' }
                            },
                            x: { 
                                title: { display: true, text: 'Hora' }
                            }
                        }
                    }
                });
                
                updateStatus('‚úÖ Gr√°fico inicializado correctamente');
            } catch (error) {
                updateStatus('‚ùå Error inicializando gr√°fico: ' + error.message, true);
            }
        }
        
        // ============================================
        // FUNCI√ìN TOTALMENTE CORREGIDA
        // ============================================
        
        async function updateChartFromSupabase() {
            console.log('üîç === ACTUALIZANDO GR√ÅFICO (TOTALMENTE CORREGIDO) ===');
            
            // Validaciones iniciales
            if (!supabaseClient) {
                updateStatus('‚ùå Cliente Supabase no disponible', true);
                return;
            }
            
            if (!consumptionChart) {
                updateStatus('‚ùå Gr√°fico no inicializado', true);
                return;
            }
            
            try {
                updateStatus('üîÑ Obteniendo datos de Supabase...');
                
                const now = new Date();
                const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                
                console.log('üìÖ Rango de consulta:', {
                    desde: yesterday.toISOString(),
                    hasta: now.toISOString()
                });
                
                // Obtener datos de Supabase
                const { data, error } = await supabaseClient
                    .from('sensor_data')
                    .select('weight, timestamp')
                    .eq('device_id', 'ESP32_SMARTGAS_DEMO')
                    .gte('timestamp', yesterday.toISOString())
                    .order('timestamp', { ascending: true });

                if (error) {
                    updateStatus('‚ùå Error consultando Supabase: ' + error.message, true);
                    return;
                }
                
                updateStatus(`‚úÖ Datos obtenidos: ${data ? data.length : 0} registros`);
                console.log(`üìä Registros encontrados: ${data ? data.length : 0}`);
                
                // Configuraci√≥n de pesos
                const emptyWeight = 5.0;
                const fullWeight = 13.0;
                
                // ============================================
                // GENERACI√ìN SEGURA DE LABELS Y DATOS
                // ============================================
                
                const labels = [];
                const netWeights = [];
                
                // Generar 24 horas con formato seguro
                for (let i = 23; i >= 0; i--) {
                    const slotTime = new Date(now.getTime() - (i * 60 * 60 * 1000));
                    // M√âTODO TOTALMENTE SEGURO
                    const hours = slotTime.getHours().toString().padStart(2, '0');
                    const minutes = slotTime.getMinutes().toString().padStart(2, '0');
                    labels.push(`${hours}:${minutes}`);
                }
                
                console.log('üïê Labels generados:', labels.slice(0, 5)); // Solo mostrar primeros 5
                
                // Procesar datos con manejo seguro
                if (!data || data.length === 0) {
                    console.log('‚ö†Ô∏è No hay datos, usando valores por defecto');
                    for (let i = 0; i < 24; i++) {
                        netWeights.push(0);
                    }
                    updateStatus('‚ö†Ô∏è Sin datos disponibles - mostrando gr√°fico vac√≠o');
                } else {
                    // Obtener √∫ltimo peso disponible
                    const lastData = data[data.length - 1];
                    const lastTotalWeight = parseFloat(lastData.weight) || 0;
                    const { netWeight: lastNetWeight } = calculateNetWeightAndPercentage(lastTotalWeight, emptyWeight, fullWeight);
                    
                    console.log('üìè √öltimo peso neto disponible:', lastNetWeight.toFixed(2) + 'kg');
                    
                    // Llenar cada slot con datos reales o √∫ltimo disponible
                    for (let i = 23; i >= 0; i--) {
                        const slotTime = new Date(now.getTime() - (i * 60 * 60 * 1000));
                        const slotStart = new Date(slotTime.getTime() - 30 * 60 * 1000);
                        const slotEnd = new Date(slotTime.getTime() + 30 * 60 * 1000);
                        
                        // Buscar datos en esta ventana horaria
                        let slotData = null;
                        for (const item of data) {
                            const itemTime = new Date(item.timestamp);
                            if (itemTime >= slotStart && itemTime <= slotEnd) {
                                slotData = item;
                                break;
                            }
                        }
                        
                        if (slotData) {
                            const totalWeight = parseFloat(slotData.weight) || 0;
                            const { netWeight } = calculateNetWeightAndPercentage(totalWeight, emptyWeight, fullWeight);
                            netWeights.push(netWeight);
                            console.log(`‚úÖ Slot ${23-i}: ${labels[23-i]} = ${netWeight.toFixed(2)}kg (dato real)`);
                        } else {
                            netWeights.push(lastNetWeight);
                            console.log(`üîÑ Slot ${23-i}: ${labels[23-i]} = ${lastNetWeight.toFixed(2)}kg (√∫ltimo disponible)`);
                        }
                    }
                    
                    updateStatus(`‚úÖ Gr√°fico actualizado con ${data.length} registros`);
                }
                
                // Actualizar gr√°fico con validaci√≥n
                if (consumptionChart && consumptionChart.data) {
                    consumptionChart.data.labels = labels;
                    consumptionChart.data.datasets[0].data = netWeights;
                    consumptionChart.update();
                    console.log('‚úÖ Gr√°fico actualizado exitosamente');
                } else {
                    throw new Error('Objeto de gr√°fico inv√°lido');
                }
                
                console.log('üìä Resumen de datos:', {
                    puntos: netWeights.length,
                    min: Math.min(...netWeights).toFixed(2) + 'kg',
                    max: Math.max(...netWeights).toFixed(2) + 'kg'
                });
                
            } catch (error) {
                console.error('‚ùå Error cr√≠tico:', error);
                updateStatus('‚ùå Error cr√≠tico: ' + error.message, true);
            }
        }
        
        // ============================================
        // FUNCIONES DE CONTADOR CORREGIDAS
        // ============================================
        
        async function getCountdownInfo() {
            if (!supabaseClient) return null;
            
            try {
                const { data, error } = await supabaseClient
                    .rpc('get_countdown_info', { device_id_param: 'ESP32_SMARTGAS_DEMO' });

                if (error) {
                    console.error('Error obteniendo contador:', error);
                    return null;
                }

                return data && data.length > 0 ? data[0] : null;
            } catch (error) {
                console.error('Error en getCountdownInfo:', error);
                return null;
            }
        }
        
        function formatTime(seconds) {
            if (seconds <= 0) return "00:00";
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        // Funci√≥n corregida para evitar errores de elementos null
        async function updateCountdownData() {
            try {
                const countdownInfo = await getCountdownInfo();
                if (countdownInfo) {
                    console.log('üìä Datos del contador actualizados:', countdownInfo);
                    
                    // Actualizar elementos del DOM de forma segura
                    const countdownTime = document.getElementById('countdown-time');
                    const countdownStatus = document.getElementById('countdown-status');
                    
                    // Solo actualizar si los elementos existen
                    if (countdownTime || countdownStatus) {
                        // Esta parte se puede omitir si no hay elementos espec√≠ficos
                        console.log('‚ÑπÔ∏è Elementos de contador no encontrados en DOM - continuando...');
                    }
                }
            } catch (error) {
                console.error('‚ùå Error actualizando contador (manejado):', error.message);
                // No mostrar error cr√≠tico, solo loguear
            }
        }
        
        // Inicializaci√≥n principal
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inicializando dashboard totalmente corregido...');
            
            initConsumptionChart();
            
            // Primera actualizaci√≥n despu√©s de 2 segundos
            setTimeout(() => {
                console.log('üîÑ Primera actualizaci√≥n del gr√°fico...');
                updateChartFromSupabase();
            }, 2000);
            
            // Actualizaci√≥n peri√≥dica cada 2 minutos
            setInterval(() => {
                console.log('üîÑ Actualizaci√≥n autom√°tica del gr√°fico...');
                updateChartFromSupabase();
            }, 2 * 60 * 1000);
            
            // Actualizaci√≥n del contador cada 30 segundos
            setInterval(updateCountdownData, 30000);
            
            updateStatus('‚úÖ Dashboard inicializado completamente');
            console.log('‚úÖ Dashboard totalmente corregido listo');
        });
        
        // Funciones expuestas para debugging
        window.updateChart = updateChartFromSupabase;
        window.testConnection = async () => {
            try {
                const { data, error } = await supabaseClient
                    .from('sensor_data')
                    .select('*')
                    .eq('device_id', 'ESP32_SMARTGAS_DEMO')
                    .limit(3);
                
                if (error) {
                    console.error('‚ùå Error de prueba:', error);
                    return { success: false, error: error.message };
                }
                
                console.log('‚úÖ Prueba exitosa:', data);
                return { success: true, data: data };
            } catch (error) {
                console.error('‚ùå Error en prueba:', error);
                return { success: false, error: error.message };
            }
        };
        
        console.log('üåê Dashboard totalmente corregido listo para usar');
        console.log('üí° Comandos √∫tiles:');
        console.log('   - updateChart() : Actualizar gr√°fico manualmente');
        console.log('   - testConnection() : Probar conexi√≥n con Supabase');
    </script>
</body>
</html>
