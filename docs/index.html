<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartHGas Dashboard - Cloud Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/supabase@2.39.3/dist/umd/supabase.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Tema claro */
            --bg-primary: #f5f7fa;
            --bg-secondary: white;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-color: rgba(0,0,0,0.05);
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --accent: #667eea;
            --success: #48bb78;
            --warning: #ed8936;
            --danger: #f56565;
        }

        [data-theme="dark"] {
            /* Tema oscuro */
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --border-color: rgba(255,255,255,0.1);
            --shadow: 0 4px 20px rgba(0,0,0,0.3);
            --accent: #667eea;
            --success: #48bb78;
            --warning: #ed8936;
            --danger: #f56565;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            font-weight: 300;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 50px;
            background: var(--bg-secondary);
            padding: 40px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            position: relative;
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: scale(1.05);
        }

        .logo {
            font-size: 2rem;
            margin-bottom: 15px;
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo svg {
            width: 60px;
            height: 60px;
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.1));
            transition: transform 0.3s ease;
        }

        .logo:hover svg {
            transform: scale(1.05);
        }

        .title {
            font-size: 2.5rem;
            font-weight: 200;
            margin-bottom: 10px;
            color: var(--text-primary);
            letter-spacing: -1px;
        }

        .subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 300;
        }

        .cloud-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 10px;
            font-weight: 400;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto;
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 40px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 400;
            margin-bottom: 25px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            font-size: 1.5rem;
        }

        /* Tarjeta de peso neto (no total) */
        .weight-display {
            text-align: center;
            margin: 20px 0;
        }

        .weight-value {
            font-size: 3.5rem;
            font-weight: 100;
            color: var(--accent);
            margin-bottom: 10px;
            letter-spacing: -2px;
        }

        .weight-unit {
            font-size: 1.2rem;
            color: var(--text-secondary);
            font-weight: 300;
        }

        .weight-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* Barra de bater√≠a mejorada - m√°s larga */
        .battery-container {
            margin: 20px 0;
        }

        .battery-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .battery-percentage {
            font-size: 1.8rem;
            font-weight: 300;
            color: var(--text-primary);
        }

        .battery-voltage {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .battery-bar-container {
            width: 100%;
            height: 25px;
            background: var(--border-color);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            border: 2px solid var(--border-color);
        }

        .battery-bar {
            height: 100%;
            border-radius: 12px;
            transition: all 0.5s ease;
            background: linear-gradient(90deg, var(--success), var(--success));
        }

        .battery-bar.warning {
            background: linear-gradient(90deg, var(--warning), #ffa726);
        }

        .battery-bar.danger {
            background: linear-gradient(90deg, var(--danger), #ff7043);
        }

        .battery-status {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 10px;
            text-align: center;
        }

        /* Gr√°fico de 24 horas */
        .chart-card {
            grid-column: 1 / -1;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }

        /* Configuraci√≥n de pesos */
        .config-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 400;
        }

        .form-input {
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .save-button {
            grid-column: 1 / -1;
            background: var(--accent);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .save-button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        /* √öltimas lecturas - solo la √∫ltima */
        .readings-list {
            margin-top: 20px;
        }

        .reading-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--bg-primary);
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
        }

        .reading-time {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .reading-value {
            font-size: 1.1rem;
            font-weight: 400;
            color: var(--text-primary);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .status-connected {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .status-disconnected {
            background: var(--danger);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        [data-theme="dark"] .error {
            background: #2d1b1b;
            color: #fc8181;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .config-form {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 20px 15px;
            }
            
            .card {
                padding: 25px;
            }
            
            .weight-value {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <button class="theme-toggle" onclick="toggleTheme()">üåô Tema Oscuro</button>
            <div class="logo">
                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle cx="50" cy="50" r="45" fill="url(#logoGradient)" />
                    <text x="50" y="65" font-family="Arial, sans-serif" font-size="48" font-weight="bold" text-anchor="middle" fill="white">S</text>
                </svg>
            </div>
            <h1 class="title">SmartHGas</h1>
            <p class="subtitle">Dashboard de Monitoreo en Tiempo Real</p>
            <div class="cloud-badge">‚òÅÔ∏è Cloud Edition</div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Peso Neto del L√≠quido -->
            <div class="card">
                <h2 class="card-title">
                    <span class="card-icon">üíß</span>
                    Nivel de L√≠quido
                </h2>
                <div class="weight-display">
                    <div class="weight-value" id="netWeight">0.00</div>
                    <div class="weight-unit">kg neto</div>
                    <div class="weight-label">L√≠quido disponible</div>
                </div>
                <div class="reading-item">
                    <span>Porcentaje:</span>
                    <span class="reading-value" id="liquidPercentage">0.0%</span>
                </div>
            </div>

            <!-- Peso Digital Total -->
            <div class="card">
                <h2 class="card-title">
                    <span class="card-icon">üî¢</span>
                    Peso Digital
                </h2>
                <div class="weight-display">
                    <div class="weight-value" id="totalWeight">0.00</div>
                    <div class="weight-unit">kg total</div>
                    <div class="weight-label">Peso completo del cilindro</div>
                </div>
                <div class="reading-item">
                    <span>Estado:</span>
                    <span class="reading-value" id="deviceStatus">
                        <span class="status-indicator status-disconnected"></span>
                        Desconectado
                    </span>
                </div>
            </div>

            <!-- Estado de Bater√≠a Mejorado -->
            <div class="card">
                <h2 class="card-title">
                    <span class="card-icon">üîã</span>
                    Estado de Bater√≠a
                </h2>
                <div class="battery-container">
                    <div class="battery-info">
                        <span class="battery-percentage" id="batteryPercentage">0%</span>
                        <span class="battery-voltage" id="batteryVoltage">0.00V</span>
                    </div>
                    <div class="battery-bar-container">
                        <div class="battery-bar" id="batteryBar" style="width: 0%"></div>
                    </div>
                    <div class="battery-status" id="batteryStatus">Desconocido</div>
                </div>
            </div>

            <!-- √öltima Lectura -->
            <div class="card">
                <h2 class="card-title">
                    <span class="card-icon">üìä</span>
                    √öltima Lectura
                </h2>
                <div class="readings-list" id="lastReading">
                    <div class="reading-item">
                        <span class="reading-time">Esperando datos...</span>
                        <span class="reading-value">--</span>
                    </div>
                </div>
            </div>

            <!-- Gr√°fico de 24 Horas -->
            <div class="card chart-card">
                <h2 class="card-title">
                    <span class="card-icon">üìà</span>
                    Consumo √öltimas 24 Horas
                </h2>
                <div class="chart-container">
                    <canvas id="weightChart"></canvas>
                </div>
            </div>

            <!-- Configuraci√≥n de Pesos -->
            <div class="card">
                <h2 class="card-title">
                    <span class="card-icon">‚öôÔ∏è</span>
                    Configuraci√≥n de Pesos
                </h2>
                <form class="config-form" onsubmit="saveConfiguration(event)">
                    <div class="form-group">
                        <label class="form-label">Peso Vac√≠o (kg)</label>
                        <input type="number" class="form-input" id="emptyWeight" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Peso Lleno (kg)</label>
                        <input type="number" class="form-input" id="fullWeight" step="0.01" min="0" required>
                    </div>
                    <button type="submit" class="save-button">üíæ Guardar Configuraci√≥n</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://uooftjtllmsnugdcldvc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvb2Z0anRsbG1zbnVnZGNsZHZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NzU3MTgsImV4cCI6MjA4MzA1MTcxOH0.L5NiZfGOlDT1vie9xEkFAFGwD-mLKAfk29FT02RwEOo';
        const DEVICE_ID = 'ESP32_SMARTHGAS_DEMO';

        // Inicializar cliente de Supabase
        const supaClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Variables globales
        let weightChart;
        let weightHistory = [];
        let currentTheme = localStorage.getItem('theme') || 'light';

        // Aplicar tema inicial
        document.documentElement.setAttribute('data-theme', currentTheme);
        updateThemeButton();

        // Funci√≥n para alternar tema
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            updateThemeButton();
            
            // Actualizar gr√°fico con nuevo tema
            if (weightChart) {
                updateChartTheme();
            }
        }

        function updateThemeButton() {
            const button = document.querySelector('.theme-toggle');
            button.textContent = currentTheme === 'light' ? 'üåô Tema Oscuro' : '‚òÄÔ∏è Tema Claro';
        }

        // Inicializar dashboard
        async function initDashboard() {
            console.log('üöÄ Inicializando SmartHGas Dashboard');
            console.log('üîó Conectando a Supabase...');
            
            try {
                // Cargar configuraci√≥n desde Supabase
                await loadConfigurationFromCloud();
                
                // Cargar datos hist√≥ricos para el gr√°fico
                await loadHistoricalData();
                
                // Inicializar gr√°fico
                initChart();
                
                // Cargar datos m√°s recientes
                await loadLatestData();
                
                // Configurar polling cada 30 segundos
                setInterval(loadLatestData, 30000);
                
                // Configurar actualizaci√≥n del gr√°fico cada 5 minutos
                setInterval(updateChartData, 300000);
                
                console.log('‚úÖ Dashboard inicializado correctamente');
            } catch (error) {
                console.error('‚ùå Error inicializando dashboard:', error);
                showError('Error de conexi√≥n con la base de datos');
            }
        }

        // Cargar configuraci√≥n desde Supabase
        async function loadConfigurationFromCloud() {
            try {
                const { data, error } = await supaClient
                    .from('device_config')
                    .select('*')
                    .eq('device_id', DEVICE_ID)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    throw error;
                }

                if (data) {
                    document.getElementById('emptyWeight').value = data.empty_weight || 0;
                    document.getElementById('fullWeight').value = data.full_weight || 0;
                    console.log('üì• Configuraci√≥n cargada desde la nube');
                } else {
                    console.log('‚ÑπÔ∏è No hay configuraci√≥n guardada en la nube');
                }
            } catch (error) {
                console.error('‚ùå Error cargando configuraci√≥n:', error);
            }
        }

        // Cargar datos hist√≥ricos para el gr√°fico (√∫ltimas 24 horas)
        async function loadHistoricalData() {
            try {
                const twentyFourHoursAgo = new Date();
                twentyFourHoursAgo.setHours(twentyFourHoursAgo.getHours() - 24);

                const { data, error } = await supaClient
                    .from('sensor_data')
                    .select('*')
                    .eq('device_id', DEVICE_ID)
                    .gte('timestamp', twentyFourHoursAgo.toISOString())
                    .order('timestamp', { ascending: true });

                if (error) throw error;

                // Procesar datos para el gr√°fico (una muestra por hora)
                weightHistory = processHourlyData(data || []);
                console.log('üìä Datos hist√≥ricos cargados:', weightHistory.length, 'puntos');
            } catch (error) {
                console.error('‚ùå Error cargando datos hist√≥ricos:', error);
                weightHistory = [];
            }
        }

        // Procesar datos para mostrar una muestra por hora
        function processHourlyData(data) {
            const hourlyData = [];
            const now = new Date();
            
            // Crear 24 slots de horas
            for (let i = 23; i >= 0; i--) {
                const hourStart = new Date(now);
                hourStart.setHours(hourStart.getHours() - i, 0, 0, 0);
                
                const hourEnd = new Date(hourStart);
                hourEnd.setHours(hourEnd.getHours() + 1);
                
                // Buscar datos en esta hora
                const hourData = data.filter(item => {
                    const itemTime = new Date(item.timestamp);
                    return itemTime >= hourStart && itemTime < hourEnd;
                });
                
                if (hourData.length > 0) {
                    // Usar el √∫ltimo dato de la hora
                    const lastItem = hourData[hourData.length - 1];
                    const netWeight = calculateNetWeight(
                        parseFloat(lastItem.weight),
                        parseFloat(lastItem.full_weight || 0),
                        parseFloat(lastItem.empty_weight || 0)
                    );
                    
                    hourlyData.push({
                        time: hourStart,
                        weight: netWeight,
                        timestamp: lastItem.timestamp
                    });
                } else {
                    // No hay datos para esta hora
                    hourlyData.push({
                        time: hourStart,
                        weight: null,
                        timestamp: null
                    });
                }
            }
            
            return hourlyData;
        }

        // Calcular peso neto
        function calculateNetWeight(totalWeight, fullWeight, emptyWeight) {
            if (!fullWeight || !emptyWeight || fullWeight <= emptyWeight) {
                return 0;
            }
            const netWeight = totalWeight - emptyWeight;
            return Math.max(0, netWeight);
        }

        // Inicializar gr√°fico
        function initChart() {
            const ctx = document.getElementById('weightChart').getContext('2d');
            
            const isDark = currentTheme === 'dark';
            const textColor = isDark ? '#f7fafc' : '#2d3748';
            const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            
            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weightHistory.map(item => {
                        return item.time.toLocaleTimeString('es-ES', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                    }),
                    datasets: [{
                        label: 'Peso Neto (kg)',
                        data: weightHistory.map(item => item.weight),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: textColor,
                                font: {
                                    size: 12,
                                    weight: '400'
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: gridColor,
                                lineWidth: 1
                            },
                            ticks: {
                                color: textColor,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: getMaxWeight(),
                            grid: {
                                color: gridColor,
                                lineWidth: 1
                            },
                            ticks: {
                                color: textColor,
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    return value.toFixed(1) + ' kg';
                                }
                            }
                        }
                    },
                    elements: {
                        point: {
                            hoverBackgroundColor: '#667eea'
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // Obtener peso m√°ximo para el eje Y
        function getMaxWeight() {
            const fullWeight = parseFloat(document.getElementById('fullWeight').value) || 20;
            const emptyWeight = parseFloat(document.getElementById('emptyWeight').value) || 5;
            return Math.max(15, fullWeight - emptyWeight);
        }

        // Actualizar tema del gr√°fico
        function updateChartTheme() {
            if (!weightChart) return;
            
            const isDark = currentTheme === 'dark';
            const textColor = isDark ? '#f7fafc' : '#2d3748';
            const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            
            weightChart.options.plugins.legend.labels.color = textColor;
            weightChart.options.scales.x.grid.color = gridColor;
            weightChart.options.scales.x.ticks.color = textColor;
            weightChart.options.scales.y.grid.color = gridColor;
            weightChart.options.scales.y.ticks.color = textColor;
            
            weightChart.update();
        }

        // Cargar datos m√°s recientes
        async function loadLatestData() {
            try {
                const { data, error } = await supaClient
                    .from('sensor_data')
                    .select('*')
                    .eq('device_id', DEVICE_ID)
                    .order('timestamp', { ascending: false })
                    .limit(1);

                if (error) throw error;

                if (data && data.length > 0) {
                    updateDashboard(data[0]);
                    console.log('üìä Datos actualizados:', new Date().toLocaleTimeString());
                } else {
                    console.log('‚ÑπÔ∏è No hay datos disponibles');
                }
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                showError('Error cargando datos del sensor');
            }
        }

        // Actualizar dashboard con nuevos datos
        function updateDashboard(data) {
            const totalWeight = parseFloat(data.weight) || 0;
            const fullWeight = parseFloat(data.full_weight) || 0;
            const emptyWeight = parseFloat(data.empty_weight) || 0;
            const batteryPercentage = parseInt(data.battery_percentage) || 0;
            const batteryVoltage = parseFloat(data.battery_voltage) || 0;

            // Calcular peso neto
            const netWeight = calculateNetWeight(totalWeight, fullWeight, emptyWeight);
            const liquidPercentage = fullWeight > emptyWeight ? 
                ((netWeight / (fullWeight - emptyWeight)) * 100) : 0;

            // Actualizar peso neto (principal)
            document.getElementById('netWeight').textContent = netWeight.toFixed(2);
            document.getElementById('liquidPercentage').textContent = liquidPercentage.toFixed(1) + '%';

            // Actualizar peso total
            document.getElementById('totalWeight').textContent = totalWeight.toFixed(2);

            // Actualizar bater√≠a
            updateBatteryDisplay(batteryPercentage, batteryVoltage);

            // Actualizar estado de conexi√≥n
            updateConnectionStatus(true);

            // Actualizar √∫ltima lectura
            updateLastReading(data);

            // Guardar datos en Supabase si es necesario
            guardarDatosEnSupabase(data);
        }

        // Actualizar display de bater√≠a
        function updateBatteryDisplay(percentage, voltage) {
            document.getElementById('batteryPercentage').textContent = percentage + '%';
            document.getElementById('batteryVoltage').textContent = voltage.toFixed(2) + 'V';
            
            const batteryBar = document.getElementById('batteryBar');
            batteryBar.style.width = percentage + '%';
            
            // Cambiar color seg√∫n el nivel
            batteryBar.className = 'battery-bar';
            if (percentage <= 20) {
                batteryBar.classList.add('danger');
                document.getElementById('batteryStatus').textContent = 'Bater√≠a cr√≠tica - Cambiar inmediatamente';
            } else if (percentage <= 50) {
                batteryBar.classList.add('warning');
                document.getElementById('batteryStatus').textContent = 'Bater√≠a baja - Preparar cambio';
            } else {
                document.getElementById('batteryStatus').textContent = 'Bater√≠a en buen estado';
            }
        }

        // Actualizar estado de conexi√≥n
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('deviceStatus');
            const indicator = statusElement.querySelector('.status-indicator');
            
            if (connected) {
                indicator.className = 'status-indicator status-connected';
                statusElement.innerHTML = '<span class="status-indicator status-connected"></span>Conectado';
            } else {
                indicator.className = 'status-indicator status-disconnected';
                statusElement.innerHTML = '<span class="status-indicator status-disconnected"></span>Desconectado';
            }
        }

        // Actualizar √∫ltima lectura (solo la m√°s reciente)
        function updateLastReading(data) {
            const timestamp = new Date(data.timestamp);
            const timeString = timestamp.toLocaleString('es-ES');
            const netWeight = calculateNetWeight(
                parseFloat(data.weight),
                parseFloat(data.full_weight || 0),
                parseFloat(data.empty_weight || 0)
            );

            document.getElementById('lastReading').innerHTML = `
                <div class="reading-item">
                    <span class="reading-time">${timeString}</span>
                    <span class="reading-value">${netWeight.toFixed(2)} kg</span>
                </div>
            `;
        }

        // Actualizar datos del gr√°fico
        async function updateChartData() {
            await loadHistoricalData();
            if (weightChart) {
                weightChart.data.labels = weightHistory.map(item => {
                    return item.time.toLocaleTimeString('es-ES', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                });
                weightChart.data.datasets[0].data = weightHistory.map(item => item.weight);
                weightChart.options.scales.y.max = getMaxWeight();
                weightChart.update();
            }
        }

        // Guardar configuraci√≥n
        async function saveConfiguration(event) {
            event.preventDefault();
            
            const emptyWeight = parseFloat(document.getElementById('emptyWeight').value);
            const fullWeight = parseFloat(document.getElementById('fullWeight').value);
            
            if (fullWeight <= emptyWeight) {
                alert('El peso lleno debe ser mayor que el peso vac√≠o');
                return;
            }
            
            try {
                const { error } = await supaClient
                    .from('device_config')
                    .upsert({
                        device_id: DEVICE_ID,
                        empty_weight: emptyWeight,
                        full_weight: fullWeight,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'device_id'
                    });

                if (error) throw error;

                console.log('‚úÖ Configuraci√≥n guardada exitosamente');
                alert('Configuraci√≥n guardada correctamente');
                
                // Actualizar gr√°fico con nuevos l√≠mites
                if (weightChart) {
                    weightChart.options.scales.y.max = getMaxWeight();
                    weightChart.update();
                }
                
            } catch (error) {
                console.error('‚ùå Error guardando configuraci√≥n:', error);
                alert('Error guardando la configuraci√≥n');
            }
        }

        // Funci√≥n para guardar datos en Supabase (compatibilidad)
        async function guardarDatosEnSupabase(data) {
            // Esta funci√≥n mantiene compatibilidad con el c√≥digo existente
            // Los datos ya se guardan desde el ESP32
            console.log('üìä Datos recibidos del ESP32:', data);
        }

        // Mostrar error
        function showError(message) {
            const container = document.querySelector('.container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            container.insertBefore(errorDiv, container.firstChild);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>
